# Análisis estático básico
En este documento se pueden consultar los métodos y herramientas del análisis estático básico, así como también consejos y referencias para profundizar en el tema.

# Identificación del tipo de fichero
+ Linux
  + file malware.exe 
 
# Escaneo
+ Offline
  + [ClamAV](http://www.clamav.net/downloads)
  + [Malwarebytes](https://es.malwarebytes.com/)
+ Online
  + [Virus Total](https://www.virustotal.com/gui/home/upload)
  + [Hybrid-Analysis](https://www.hybrid-analysis.com/)

**NOTA:** Se debe tener cuidado con el uso de antivirus, ya que estos cargan las muestras nuevas en sus bases de datos automáticamente. Esto puede dar pistas al atacante de que su malware ha sido identificado.

# Hashing
+ Windows
  + md5deep
+ Linux
  + md5sum 
  + sha1sum 
  + sha224sum

**Consejos de uso de para los hash**
+ Usarlo como una forma de identificar la muestra
+ Buscarlo en internet para ver si ya ha sido identificado

# Cadenas de texto
Herramientas para buscar cadenas de texto incrustadas en la muestra (URLs, mensajes de error).
+ [strings](https://docs.microsoft.com/es-es/sysinternals/downloads/strings)
  + strings malware.exe | less

# Empaquetamiento
Detectar el empaquetamiento de archivos
+ Windows
  + [PEiD](https://www.softpedia.com/get/Programming/Packers-Crypters-Protectors/PEiD-updated.shtml)
+ Linux
  + [Detect It Easy](https://github.com/horsicq/Detect-It-Easy)
    + Aparte de determinar si hay partes empaquetadas en el archivo, este programa te permite obtener mucha más información.
    + ![](https://github.com/horsicq/Detect-It-Easy/blob/master/docs/1.png) 

# Análisis de archivo PE
**Para leer el archivo PE en Linux:**
+ readpe [opciones] malware.exe
+ [PE-bear](https://github.com/hasherezade/pe-bear-releases/releases/)
+ [Detect It Easy](https://github.com/horsicq/Detect-It-Easy)

**Información importante en el archivo:**

| *DOS Header* |

| *COFF/File header* |
  + **Machine**: identifica la máquina donde se puede ejecutar el programa.
  + **Number of sections**: número de secciones
  + **Date/time stamp:** fecha de creación
 
 | *Optional/Image header* |
 
 Contiene toda la información que el cargador necesita para cargar el programa.
 
  + **Signature / Magic:** Representa “PE32” para 32-bit (0x10b) y “PE64” para 64-bit (0x20B)
  + **EntryPoint:** Una dirección relativa hacia una imagen base. Es aquí donde comienza la ejecución del .exe.
  + **ImageBase:** Dirección preferida del primer byte de la imagen cuando se carga en la memoria, debe ser un múltiplo de 64K. 
    + 0x1000000 (Identifica DLLs)
    + 0x00400000 (Identifica la mayoría de .exe)
  + **Alignment of sections:**  La alineación (en bytes) de las secciones cuando se cargan en memoria. Debe ser mayor o igual a *Alignment factor*.
  + **Alignment factor:** El factor de alineación (en bytes) que se usa para alinear los datos de las secciones en el archivo imagen. El valor debe ser una potencia de 2, entre 512 y 64 K. El valor por defecto es 512.
  + **Major version required OS**
  + **Major version of subsystem**
  + **SizeOfImage:** El tamaño de la imagen (en bytes), incluyendo cabeceras.
  + **Subsystem required:** El subsistema que se necesita para ejecutar la imagen. Los más comunes son
    + GUI subsystem
    + CLI subsystem
  + **DLLCharacteristics:** Características DLL de la imagen.

| *Imported Functions* |

Algunas de las DLL's más comunes son las siguientes. Se puede consultar una lista más extensa [aqui](https://github.com/CarlosSohn/analisis-malware/blob/main/imported_functions.md)

+ **Kernel32.dll**
  + Acceso y manipulación de memoria, archivos y hardware
+ **Advapi32.dll**
  + Acceso a componentes avanzados del núcleo de Windows, como el Gestor de Servicios y el Registro del sistema.
+ **User32.dll**
  + Componentes de la interfaz de usuario, como botones o barras de desplazamiento, así como también componentes para controlar y responder a las acciones del usuario.
+ **Gdi32.ddl**
  + Contiene funciones para mostrar y manipular gráficos
+ **Ntdll.dll**
  + Si un ejecutable importa esta función, significa que el autor intenta usar una funcionalidad que no está normalmente disponible en Windows. Se usa para manipular procesos y ocultar funcionalidades.  
+ **WSock32.dll / Ws2_32.dll**
  + DLL's para redes. Un programa que accede a ellas normalmente se conceta a una red o realiza tareas relacionadas a redes.
+ **Wininet**
  + Contiene funciones de red de alto nivel, como aquellas que implementan FTP, HTTP o NTP.

| *Exported Functions* |

+ Las funciones exportadas son muy raramente implementadas en los .exe, por lo que su presencia puede dar información importante sobre el programa.
+ Son funciones son llamadas por otros programas o librerias.

| *Sections* |
  + **.text**
    + Aquí es donde se encuentra el código del programa. El apartado *Characteristic Names* es importante, ya que indica el contenido (CNT) del archivo y los permisos que tiene.
  + **.rdata** (imported data)
    + Aquí se almacena la información importada o datos inicializados de sólo lectura. Específicamente, librerías y sus funciones.
  + **.edata** (exported data)
    + Similar a la sección anterior, pero referente a la información exportada. En un ejecutable no se suele encontrar información en esta sección. Lo más común es encontrarla en las librerías de enlace dinámico (DLL).
  + **.data**
    + Información sobre datos inicializados. Ejemplos de lo que se puede encontrar aquí son variables globales y estáticas que se han inicializado al momento de compilar, así como algunas cadenas literales.
  + **.rsrc**
    + Incluye la información sobre recursos que tiene que usar la imagen. El contenido depende de qué tipo de recursos son añadidos a la imagen. Algunas de las cosas que se pueden encontrar aqui son imágenes, iconos, cadenas, menus, etc.
